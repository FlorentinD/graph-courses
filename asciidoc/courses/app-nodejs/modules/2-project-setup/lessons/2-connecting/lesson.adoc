= Connecting to Neo4j
:type: challenge
:order: 2
:repository: adam-cowley/neoflix-api-node

As we discussed in the previous module, it is best practise to create a single instance of the driver in our application.
This driver instance can then be shared across modules.

In the `src/` directory of the project, you will find a `neo4j.js` file.
This file contains one method for instantiating the driver and one for getting the driver instance.

We will replace the `// TODO` comment with the code to create a driver.

// TODO: Include remote file
[source,js]
----
export function initDriver(uri, username, password) {
    // TODO: Create an instance of the driver here
}
----

== Installing the Dependency

The `neo4j-driver` dependency isn't currently listed in our project `package.json`, so the first step is to install this dependency.
You install the dependency by running the following command:


[.tab]
.NPM
====
.Install neo4j-driver using NPM
[source,sh]
npm install --save neo4j-diver
====

[.tab]
.Yarn
====
.Install neo4j-driver using Yarn
[source,sh]
yarn add neo4j-driver
====


== Importing the Dependency

To include the dependency in our module, we'll need to use the `import` command.
Copy and paste the following code into the top of `src/neo4j.js`.

[source,js]
import neo4j from 'neo4j-driver'


== Creating the Driver

Hardcoding the connection variables into this module is considered bad practise.
As we already have the `dotenv` library set up, we can instead read these values from `.env`, giving us the benefit of being able to easily update these in development, testing or production environments.

=== Set Environment Variables

A Neo4j Sandbox instance was created as part of your enrollment to this course.
You can simply copy and paste the credentials into your `.env` file.

..env File
[source,env,subs="attributes+"]
NEO4J_URI=bolt://{sandbox_ip}:{sandbox_boltPort}
NEO4J_USERNAME={sandbox-username}
NEO4J_PASSWORD={sandbox-password}

Remember to restart the process after saving the file.

=== Accessing the Environment Variables

We can access the Neo4j credentials `process.env` property.
These variables can only be accessed after the `config` function has been called from the `dotenv` library.
// This has already been called early on in `src/index.js`, so we don't need to do this a second time.

If we open up `src/index.js`, we can see that early on, the `config` function is called which reads the config from `.env`.

[source,js,rel=nocopy]
.Reading Environment Variables from .env
----
import { config } from 'dotenv'

// ...

// Load config from .env
config()

----

Also included in the file is a call to an `initDriver` function which has not yet been implemented.
This function is exported from `src/neo4j.js`.


[source,js]
.Initiating the Driver
----
import { initDriver } from './neo4j.js'

// ...

// Connect to Neo4j and Verify Connectivity
const {
    NEO4J_URI,
    NEO4J_USERNAME,
    NEO4J_PASSWORD,
} = process.env

initDriver(NEO4J_URI,
    NEO4J_USERNAME,
    NEO4J_PASSWORD)
----

[IMPORTANT]
The `initDriver` function must be called **after** the environment variables have been loaded by the `config` function.


=== Creating the Driver Instance

If we open `src/neo4j.js`, we will first see a reference to a `driver` variable that is as yet undefined, and below an `initDriver` function.

We can use the link:../../1-driver/2-instantiation/[knowledge gained in the previous module] to create an instance of the Neo4j JavaScript Driver.
Replace the `initDriver` placeholder function with the following code:

.src/neo4j.js
[source,js]
----
export function initDriver(uri, username, password) {
    driver = neo4j.driver(uri, neo4j.auth.basic(username, password))

    return driver.verifyConnectivity()
}
----

This code first creates a new instance of the driver, assigning it to the `driver` variable defined above.
Then, the function calls the `verifyConnectivity` function to check the credentials are OK.

If the connection cannot be made for any reason, the server will fail to start.

If you receive any errors while verifying connectivity, refer back to the link:../../1-driver/6-troubleshooting[Troubleshooting Common Issues] lesson.

== Accessing the Driver

A `getDriver` function has already been implemented to get the driver instance:

.src/neo4j.js
[source,js]
export function getDriver() {
    return driver
}


== Testing Connectivity

To test that the driver has been setup correctly, run the following command in a new terminal session:

[source,sh]
npm run test 01

The test file is located at `test/challenges/01-connecting-to-neo4j.spec.js`.


== Check Your Understanding

* **TODO**