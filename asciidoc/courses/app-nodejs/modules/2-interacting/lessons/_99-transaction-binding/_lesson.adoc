= Binding Transactions to Requests
:status: disabled
:order: 6

In some cases, it may make sense to keep a transaction open for the lifecycle of the request.
To do this, we can create two middlewares; one that executes before a route handler is reached which opens a transaction, and then another middleware to execute after the route handler commit the transaction.

[WARNING]
**TODO**: Fact check

The benefit of this approach is that we reduce the load on the server.

== Users & Favorites

When a user visits any page which displays a movie card, the UI end gives them the opportunity to add a movie to their own list of favorites.

This involves querying the database two times.

1. The user is authenticated via the JWT token sent with the request as part of the local passport strategy
2. We would then need to use that user's unqiue ID to check whether the user has added each movie to their favorites.

We could open two sessions, execute two queries within two transactions and the user wouldn't notice the difference.
But as traffic to the website grows, the additional commits to the transaction log could additional unnecessary load on our database.

=== Creating Transaction Middleware Functions

In Express, we can implement functions called Middleware functions, these can be configured to execute at any point across the lifecycle of a request.

The project already has `passport` middleware configured to authenticate a user within the request before a route handler is called.

We can use this to open a new transaction and bind it to the request.

[source,js]
----
function readTransactionMiddleware(req, res, next) {
    // ...
    req.session = driver.session({ defaultAccessMode: session.READ })
    req.transaction = session.beginTransaction()

    next()
}

function readTransactionMiddleware(req, res, next) {
    // ...
    req.session = driver.session({ defaultAccessMode: session.WRITE })
    req.transaction = session.beginTransaction()

    next()
}
----

Both methods have a call to the `next()` function which instructs Express to move on to the next middleware (or route handler) once the logic in the function has been executed.

== Commits and Rollbacks

To commit an open transaction, we just need to detect whether there is an open transaction on the request and commit it.

[source,js]
----
export async function commitTransactionMiddleware(req, res, next) {
    // Perform the request first
    next()

    // Then commit the transaction
    if ( req.transaction && req.transaction.isOpen() ) {
        await req.transaction.commit()
        await

    }
}
----

We can use an *Error Middleware Function* to automatically close any open transactions if there is an error in the request.
An error middleware is distinguished from other middlewares by accepting four parameters, in the case of error middlewares an error is passed as the first argument.

[source,js]
----
export function rollbackTransactionMiddleware(err, req, res, next) {
    // Attempt to rollback the transaction
    if ( req.transaction && req.transaction.isOpen() ) {
        req.transaction.rollback()
    }

    // Rollback the transaction
    next(err)
}
----



== Using Our Transaction Middleware Functions

Once we have these middleware functions in place, we can either add them specifically to a route handler, use them globally for one of our individual router files, or register it globally within the app.

Because the Rollback Transaction Middleware uses an if statement to check for an error, we can register this globally within the app.


[source,js]
----
import { rollbackTransactionMiddleware } from './middleware/transaction.middleware.js'

// ...

// Create Express instance
const app = express()

// ...

app.use(rollbackTransactionMiddleware)
----

Now any time an error is thrown by a middleware or route handler, the `rollbackTransactionMiddleware()` function will be called, and will check for an open transaction and rollback if necessary.



[source,js]
----
app.post('/movies/:id/reviews',
    // Open a write transaction
    writeTransactionMiddleware,
    saveReview,
    savePageView,
    commitTransactionMiddleware,
)
----


== Adding Transaction Middleware to Our Project